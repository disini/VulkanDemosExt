# Vulkan NDC 坐标系

Vulkan NDC坐标系与其它库的坐标系有点儿不一致，特此记录一下。

### NDC坐标系(Normalized Device Coordinates)

NDC也称之为设备空间即标准化设备坐标系，无论引擎中的坐标系是如何，有没有使用到相机空间、世界空间、投影空间等等，最终我们都需要统一到一个统一的坐标系下，这个坐标系也可以理解为应用程序与GPU的接口。

### 常规NDC坐标系

为什么我会提到常规坐标系呢，因为在开发的这几年当中，无论是Directx、OpenGL、WebGL甚至于喜欢搞事的苹果，它家的Metal都是一个统一的坐标系。也就是Directx、OpgnGL、WebGL、Metal它们的NDC空间都是一致的即左手系。左手系坐标轴为：X轴朝右方、Y轴朝上方、Z轴朝前方。

### 屏幕坐标系

有过2D开发的同学就会注意到，在2D APP开发当中，坐标系又是以左上角为原点，X轴朝右，Y轴朝下的。Directx、OpenGL、WebGL、Metal中的NDC坐标系与屏幕坐标不一致，又导致了通过它们制作的基于GPU渲染的2D UI库坐标系又比较难处理，又是一个坑爹的毛病。比如Cocos2D-x：

https://www.cocos.com/docs/native/v3/coordinate-system/zh.htmlwww.cocos.com



至于为什么这里不能统一，就是因为屏幕坐标系的Y轴与NDC坐标系中的Y轴刚好相反，然而我们并不能通过线性矩阵在处理投影时将它们统一起来。通俗讲就是不能通过MatrixA MatrixB Projection MatrixC的方式将NDC坐标系进行翻转，这里不详细讨论这个问题，大家可以自行去推导，这个的缘由我只是随手提一下。

### Vulkan NDC坐标系

说完了上面的这些坐标系之后，又来讲Vulkan中的NDC坐标系，说它跟其它的有点儿不一样就是因为它使用了右手系。除了Y轴，其它两个轴它都跟别人一致。那么这个Y轴进行了翻转之后，就让广大开发者有点儿恶心了，因为之前当其它库的API Caller已经熟悉了它们的坐标系，现在又搞了一个不一样的，在开发期间就增加了一些设计上的难道。可能有人认为这个很容易解决，对设计没有任何障碍，但是其实不然，特别是现有跨平台的图形库，想要支持Vulkan就得要考虑坐标系的适配问题。

### Vulkan三角形示例

我们先来看一下一个案例，来对比一下不同之处。以下是Vulkan里面的一个三角形的数据定义：[顶点定义代码地址](https://github.com/BobLChen/VulkanTutorials/blob/master/examples/2_Triangle/Triangle.cpp#L472)

```
// 前3为坐标点，后3为顶点色。
std::vector<Vertex> vertices = {
	{ {  1.0f,  1.0f, 0.0f }, { 1.0f, 0.0f, 0.0f } },
	{ { -1.0f,  1.0f, 0.0f }, { 0.0f, 1.0f, 0.0f } },
	{ {  0.0f, -1.0f, 0.0f }, { 0.0f, 0.0f, 1.0f } }
};

// 索引数据
std::vector<uint16> indices = { 0, 1, 2 };
```

大家注意顶点坐标以及索引顺序，然后我们来看一下显示的三角形。

![img](https://pic2.zhimg.com/v2-ab126e43a826dbe432241c3e5834e159_b.jpg)

### OpenGL三角形示例

然后我们再来看一下OpenGL里面的三角形定义。[代码定义](http://www.opengl-tutorial.org/beginners-tutorials/tutorial-2-the-first-triangle/)

```
// An array of 3 vectors which represents 3 vertices
static const GLfloat g_vertex_buffer_data[] = {
   -1.0f, -1.0f, 0.0f,
   1.0f, -1.0f, 0.0f,
   0.0f,  1.0f, 0.0f,
};
```

![img](https://pic4.zhimg.com/v2-8889fe98248a994d49e15a38a35fb5ff_b.png)

大家发现没有，同样的三角形数据定义却不一样。那么这个问题如果要解决的话，要怎么解决呢？我在这里列举一下常规解决方式：

### 解决方式1

翻转投影矩阵，我们可以让我们的投影矩阵Projection进行垂直翻转，处理也很简单，Y轴缩放乘以-1即可。但是这样处理之后就会引入一些其它的问题，第一个是三角形剔除的问题，因为我们进行了垂直翻转，那么我们的三角形顺序就变了，以前是顺时针的现在就变成了逆时针。然而我们的正面、背面剔除又是根据这个来的，那么我们翻转了投影矩阵之后，我们也需要修改我们的剔除方式、顺时针逆时针方向。第二问题就是法线的问题，投影矩阵只是针对顶点坐标，不是针对顶点属性的，翻转了投影矩阵也只是翻转了顶点坐标系，顶点属性并未翻转，那么跟顶点相关的矢量也要一并翻转。这种方式处理起来就异常麻烦了，可能整个引擎架构都需要随之调整。

### 解决方式2

既然翻转投影矩阵异常麻烦，那么我们可以考虑在顶点Shader里面进行翻转，在顶点Shader里面，我们只需要对顶点输入的时候做一次转换，将顶点坐标以及附带的矢量一起翻转，然后将包装之后的属性提供出来使用。

### 解决方式3

由于这样需求的人太多了，导致Vulkan在发布之后没过多久就立马推出了扩展，可以让开发者将Viewport整个进行翻转，但是这样是个扩展，也就是Android或者IOS、MacOS不一定能用。

### 解决方式4

妥协，直接使用这个坐标系，可能初期不太习惯，后期就习惯了。虽然习惯了，但是这个也是比较麻烦的，对于已经开发过其它3D引擎的人来说，他们手里面已经握着一些常用库了。比如模型解析库，解析出来的模型坐标系已经是跟左手细对应上了，结果现在解析出来放到Vulkan里面却发现模型翻转了。只是静态模型其实还好处理，关键麻烦的是我们还有骨骼动画，还涉及到骨骼是不是需要翻转，翻转了之后能不能用等等问题。

目前这个问题我还没想好我自己要怎么处理，我可能会尝试一下2、4的方式，看看会不会遇到一些其它的坑爹问题，如果有的话到时候再来记录一下吧。